<?php
/**
* Implementation of hook_permission().
*/
function campaign_thermometer_permission() {
  return array(
    'access campaign_thermometer' => array('title' => t('Campaign Thermometer'))
  );
}

/**
 
* Implementation of hook_menu().
*/
function campaign_thermometer_menu() {
  $items = array();

  $items['campaignwidget'] = array(
    'title' => 'Avancement de la campagne',
    'page callback' => 'campaignwidget',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK
  );

    return $items;
}

function campaign_thermometer_theme_registry_alter(&$theme_registry) {
    // Defined path to the current module.
    $module_path = drupal_get_path('module', 'campaign_thermometer');
    // Find all .tpl.php files in this module's folder recursively.
    $template_file_objects = drupal_find_theme_templates($theme_registry, '.tpl.php', $module_path);
    // Iterate through all found template file objects.
    foreach ($template_file_objects as $key => $template_file_object) {
        // If the template has not already been overridden by a theme.
        if (!isset($theme_registry[$key]['theme path']) || !preg_match('#/themes/#', $theme_registry[$key]['theme path'])) {
            // Alter the theme path and template elements.
            $theme_registry[$key]['theme path'] = $module_path;
            $theme_registry[$key] = array_merge($theme_registry[$key], $template_file_object);
            $theme_registry[$key]['type'] = 'module';
        }
    }
}
 
function campaignwidget() {
  $return_page=get_donations_amount('2015-12-00');
  return $return_page;
}

function get_donations_amount($date) {
  global $base_url;

  $str_return= '';
  	
  $query = db_select('civicrm_contribution', 'c');
 
  $query
    ->condition('financial_type_id', array(1,3), 'IN') /* 1 : Don, 3 : contribution campagne*/
    ->condition('contribution_status_id', '1')
    ->condition('receive_date', $date,'>=');
  $query->addExpression('FLOOR(SUM(total_amount))', 'amount');
 
  $result = $query->execute()->fetchAll();;
  $data = (array)$result[0];
  $amount = $data['amount'];

  $str_return.="<div id=\"donations-thermometer\">
  <h3>On a besoin de vous !</h3>
  <p>$amount / 300 000
  <p>Wikimédia France ne vit que grâce à vous.</p>
<p><a href=\"$base_url/civicrm/contribute/transact?reset=1&id=2\" title=\"Soutenez-nous\">Soutenez-nous !</a></p>
</div>";
  
  return $str_return;
}